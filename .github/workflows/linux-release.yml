name: Linux Release
on:
  push:
    tags:
      - 'v*'
permissions:
  contents: write
jobs:
  build-appimage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Read Flutter version
        id: flutter-version
        run: echo "version=$(cat .flutter-version)" >> $GITHUB_OUTPUT
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.flutter-version.outputs.version }}
          channel: 'stable'
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build libgtk-3-dev
      - name: Install appimagetool
        run: |
          sudo wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -O /usr/local/bin/appimagetool
          sudo chmod +x /usr/local/bin/appimagetool
      - name: Build AppImage
        run: ./scripts/package-linux.sh
      - name: Upload to Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          artifacts: "*.AppImage"
          allowUpdates: true
          replacesArtifacts: true
          draft: false
          prerelease: ${{ contains(github.ref, 'rc') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
