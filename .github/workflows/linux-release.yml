name: Linux Release
on:
  push:
    tags:
      - 'v*'
permissions:
  contents: write
jobs:
  build-appimage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Read Flutter version
        id: flutter-version
        run: echo "version=$(cat .flutter-version)" >> $GITHUB_OUTPUT
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.flutter-version.outputs.version }}
          channel: 'stable'
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build libgtk-3-dev
      - name: Build Rust library
        run: |
          cargo build --release --manifest-path rust/ecashapp/Cargo.toml --target-dir rust/ecashapp/target
          mkdir -p build/linux/x64/release/bundle/lib
          cp rust/ecashapp/target/release/libecashapp.so build/linux/x64/release/bundle/lib/
      - name: Build AppImage
        run: |
          flutter pub get
          flutter build linux --release
          wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
          mkdir -p AppDir/usr/share/icons/hicolor/512x512/apps
          mkdir -p AppDir/usr/share/metainfo
          cp -r build/linux/x64/release/bundle/* AppDir/
          cp linux/runner/ecash-app.png AppDir/usr/share/icons/hicolor/512x512/apps/
          cp linux/runner/ecash-app.png AppDir/ecash-app.png
          mkdir -p AppDir/usr/share/applications
          cp linux/runner/org.fedimint.app.desktop AppDir/
          cp linux/runner/org.fedimint.app.desktop AppDir/usr/share/applications/
          cp linux/appstream/org.fedimint.app.appdata.xml AppDir/usr/share/metainfo/
          ln -sf ecashapp AppDir/AppRun
          VERSION=$(grep "^version:" pubspec.yaml | cut -d" " -f2)
          ARCH=x86_64 ./appimagetool AppDir "ecash-app-${VERSION}-x86_64.AppImage"
      - name: Upload to Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          artifacts: "*.AppImage"
          allowUpdates: true
          replacesArtifacts: true
          draft: false
          prerelease: ${{ contains(github.ref, 'rc') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
